# リファクタリング戦略

このドキュメントは、プロジェクト全体のコードのリファクタリングに関する指針と戦略をまとめたものです。

## 1. 単一責任原則 (SRP)
- 各クラスや関数は、単一の責任のみを持つこと。特に肥大化しているメソッドを分割し、明確な責務に切り分ける。
- BigQueryクライアントとdatacatalog lineageクライアントは分離し、それぞれが特定のタスクのみを担当するようにする。

## 2. ネストの軽減と早期returnの徹底
- if文やfor文のネストを可能な限り避け、早期returnを積極的に活用する。
- どうしてもネストが必要な場合、その処理を個別の関数やクラスに分割する。

## 3. コマンド実装の可読性向上
- import_cmd.pyのリファクタリングを行い、処理の流れを分かりやすくする。
- 複雑なロジックはサブ関数または別モジュールに分割し、単一責任に従った設計を目指す。

## 4. ディレクトリとファイル構成の見直し
- src/bq2dbt/commands/内のファイル名から「_cmd」を排除し、シンプルで直感的な命名にする。
- 各モジュールの責務がディレクトリ構造で明確に分かれるように、全体の構成を再検討する。

## 5. DependencyResolverのシンプル化
- 現在のDependencyResolverは複雑なグラフ構築や循環参照検出を行っているが、これをシンプルな再帰的取得に変更する。
- datacatalog lineage clientで依存関係を取得後、事前に指定した深さまで再帰的にソースを取得する手法にする。

## 6. 拡張性の確保
- 依存関係解析の実装を抽象化し、将来的にdatacatalog lineage client以外の手法（例：SQL解析）にも対応できるようにする。
- インターフェースや抽象クラスを活用し、異なる実装を容易にプラグインできる設計とする。

## 7. コーディング規約の遵守
- すべての関数、クラス、メソッドに対して型ヒントとドキュメントを整備する（Googleスタイルのdocstring推奨）。
- プロジェクトの既存ルールと合わせ、一貫性のあるコーディングスタイルを維持する。

以上のガイドラインに沿って、コードベースの保守性、拡張性、および可読性を向上させるリファクタリングを実施していきます。

# リファクタリング実施内容

## 1. BigQueryClientとLineageClientの分離

### 問題点
- `BigQueryClient`と`LineageClient`が同じファイル（`src/bq2dbt/converter/bigquery.py`）に定義されていた
- 単一責務の原則に違反しており、それぞれのクライアントが異なる責務を持っていた
- `LineageClient`が`BigQueryClient`と同居していることで、コードの見通しが悪くなっていた

### 実施した変更
1. **LineageClientの分離**:
   - 新しいファイル `src/bq2dbt/converter/lineage.py` を作成
   - `LineageClient` クラスを `bigquery.py` から `lineage.py` に移動
   - 適切なドキュメントとインポートを追加

2. **DependencyResolverの更新**:
   - `DependencyResolverBase` クラスはそのまま維持
   - `DataCatalogDependencyResolver` クラスが明示的に `LineageClient` を受け取るように変更
   - 後方互換性のために `DependencyResolver` クラスを維持し、内部で `LineageClient` を作成するように実装

3. **テストの更新**:
   - `test_dependency.py` のテストを更新して、新しい構造に対応
   - `LineageClient` のモックを適切に設定
   - `DataCatalogDependencyResolver` と `DependencyResolver` の両方をテスト

### 利点
1. **単一責務の原則の遵守**:
   - `BigQueryClient` はBigQueryのテーブル/ビュー操作のみに責任を持つ
   - `LineageClient` はData Catalog Lineage APIとの通信のみに責任を持つ

2. **コードの見通しの向上**:
   - 各クライアントが独立したファイルに存在することで、コードの理解が容易になる
   - 関連する機能が論理的にグループ化される

3. **拡張性の向上**:
   - 将来的に異なる依存関係解析方法（SQL解析など）を追加する際に、`DependencyResolverBase` を継承した新しいクラスを作成するだけで対応可能
   - `LineageClient` の機能を拡張する際に、`BigQueryClient` に影響を与えない

4. **テスト容易性の向上**:
   - 各クライアントを個別にモック化できるため、テストが簡単になる
   - 依存関係が明示的になり、テストの意図が明確になる

## 2. DependencyResolverクラスの改善

### 問題点
- 依存関係解析の処理が複雑で、グラフ構築や循環参照の検出が遅かった
- 単純に再帰的に深さを決めてソースを取得する方法が必要だった

### 実施した変更
1. **抽象基底クラスの導入**:
   - `DependencyResolverBase` 抽象基底クラスを作成し、共通インターフェースを定義
   - 具体的な実装を `DataCatalogDependencyResolver` に移動
   - 後方互換性のために `DependencyResolver` をエイリアスとして維持

2. **依存関係解析の簡素化**:
   - 複雑なグラフ構築と循環参照検出を簡素化
   - 指定された深さでソースを取得する再帰的な方法に変更
   - 最大深さを指定できるキュー型のBFS（幅優先探索）アルゴリズムを採用

3. **トポロジカルソートの簡素化**:
   - 複雑な循環参照検出を削除
   - 深さに基づいて依存関係をソート
   - 各ビューの深さを計算し、降順でソート

### 利点
1. **シンプルさ**:
   - コードがより理解しやすく、メンテナンスしやすくなった
   - 不必要な複雑さを排除

2. **拡張性**:
   - 新しい依存関係解析方法を追加しやすい設計
   - 抽象基底クラスを通じて共通インターフェースを提供

3. **パフォーマンス**:
   - 深さを指定することで、不必要な依存関係の解析を回避
   - 循環参照の検出が不要になり、処理が高速化

4. **機能強化**:
   - 依存関係の取得に最大深さを指定できる機能を追加
   - これにより、大規模なビュー階層でも効率的に処理可能

## 3. モジュール構造の改善

### 問題点
- `commands/importer.py` ファイルが肥大化し、コマンドラインインターフェースとビジネスロジックが混在していた
- 単一責任の原則に違反しており、コードの理解と保守が困難だった
- テストが複雑になり、ビジネスロジックとCLIの両方を同時にテストする必要があった

### 実施した変更
1. **ビジネスロジックとCLIの分離**:
   - ビジネスロジックを `converter/importer.py` に移動
   - CLIコマンド定義を `commands/import_views.py` に実装
   - `commands/importer.py` はコマンドグループの定義のみに簡素化

2. **関数の分割と責任の明確化**:
   - 大きな `import_views` 関数を複数の小さな関数に分割
   - 各関数が単一の責任を持つように設計
   - 関数間の依存関係を明確化

3. **パラメータの受け渡しの改善**:
   - `BigQueryClient` の初期化時に `location` パラメータをキーワード引数として渡すように修正
   - `ModelGenerator` の初期化方法を改善し、出力ディレクトリを後から設定できるように変更

4. **テストの更新**:
   - `test_importer.py` を更新して、ビジネスロジックの関数をテスト
   - `test_import_cmd.py` を更新して、CLIコマンドをテスト
   - モックの設定を適切に更新

### 利点
1. **責任の分離**:
   - `commands` モジュールはCLIインターフェースのみに責任を持つ
   - `converter` モジュールはビジネスロジックのみに責任を持つ

2. **コードの見通しの向上**:
   - 各モジュールが明確な責任を持つことで、コードの理解が容易になる
   - 小さな関数に分割されたことで、各処理の流れが明確になる

3. **依存関係の明確化**:
   - `commands` モジュールが `converter` モジュールに依存する一方向の依存関係を確立
   - 循環依存を排除し、コードの理解と保守を容易にする

4. **テスト容易性の向上**:
   - ビジネスロジックとCLIを個別にテストできるため、テストが簡単になる
   - モックの設定が明確になり、テストの意図が理解しやすくなる

5. **拡張性の向上**:
   - ビジネスロジックを変更せずにCLIを変更できる
   - 将来的にGUIなど別のインターフェースを追加する際に、ビジネスロジックを再利用できる

## 今後の改善点

1. **さらなる依存関係解析方法の追加**:
   - SQL解析による依存関係の検出など、他の方法を実装可能

2. **パフォーマンス最適化**:
   - 大量のビューを処理する際のさらなる最適化

3. **エラーハンドリングの強化**:
   - より詳細なエラーメッセージと回復メカニズムの提供

4. **ユーザーインターフェースの改善**:
   - 依存関係の視覚化機能の強化

5. **モジュール構造のさらなる改善**:
   - 残りのコマンドも同様の方針でリファクタリング
   - 共通ユーティリティの整理と再利用の促進

6. **ドキュメントの充実**:
   - 各モジュールの責任と使用方法の詳細なドキュメント作成
   - アーキテクチャ図の更新 