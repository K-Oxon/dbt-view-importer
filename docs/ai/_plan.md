# bq2dbt プロジェクト実装計画

## 現在の進捗状況 (2024/03/05 追加)

### 完了したタスク
- プロジェクト構造の整備（フォルダ構造、基本ファイルの作成）
- 依存関係の設定（pyproject.toml）
- BigQuery APIクライアントの基本実装
  - ビュー一覧取得機能
  - ビュー定義取得機能
  - ビュースキーマ取得機能
  - テーブル依存関係取得機能
- 依存関係解析の基本実装
- モデル生成機能の実装
- CLIインターフェースの基本実装
  - インポートコマンド
  - コマンドライン引数処理
- テストの基本実装
  - BigQueryクライアントのテスト
  - 依存関係リゾルバーのテスト
  - モデルジェネレーターのテスト
  - コマンドテスト

### 実装中/一部完了のタスク
- テスト強化（モック改善、カバレッジ向上）
- エラーハンドリングの強化

### 未着手のタスク
- ログコマンドの実装
- インタラクティブな確認機能の完成
- ドキュメントの作成と充実
- リリース準備（パッケージング、CHANGELOG作成）

## 1. プロジェクト構造の整備

### 1.1 ディレクトリ構造の作成
```
project_root/
├── .git/
├── .gitignore
├── README.md
├── pyproject.toml
├── tests/
│   ├── __init__.py
│   ├── conftest.py
│   ├── test_cli.py
│   └── test_converter.py
└── src/
    └── bq2dbt/
        ├── __init__.py
        ├── __main__.py
        ├── cli.py
        ├── commands/
        │   ├── __init__.py
        │   ├── import_cmd.py
        │   └── logs_cmd.py
        ├── converter/
        │   ├── __init__.py
        │   ├── bigquery.py
        │   ├── dependency.py
        │   └── generator.py
        ├── templates/
        │   ├── __init__.py
        │   ├── model.sql
        │   └── model.yml
        └── utils/
            ├── __init__.py
            ├── logger.py
            └── naming.py
```

### 1.2 基本ファイルの作成
- READMEの作成（インストール手順、使い方を記載）
- .gitignoreの設定（Pythonプロジェクト用）
- pyproject.tomlの完成（依存関係の追加）

## 2. 依存関係の設定

### 2.1 必要なライブラリの追加
```toml
[project]
dependencies = [
    "click>=8.1.0,<9.0.0",
    "rich>=12.0.0,<13.0.0",
    "google-cloud-bigquery>=3.10.0,<4.0.0",
    "google-cloud-bigquery-datatransfer>=3.11.0,<4.0.0",
    "jinja2>=3.1.2,<4.0.0",
    "pyyaml>=6.0,<7.0",
]

[project.optional-dependencies]
dev = [
    "mypy>=1.15.0",
    "ruff>=0.9.9",
    "pytest>=7.0.0,<8.0.0",
    "pytest-cov>=4.0.0,<5.0.0",
    "pre-commit>=3.0.0,<4.0.0",
]
```

### 2.2 エントリーポイントの設定
```toml
[project.scripts]
bq2dbt = "bq2dbt.cli:main"
```

## 3. コア機能の実装

### 3.1 ユーティリティの実装
- ロガー（utils/logger.py）
  - ログレベル設定
  - ファイルログとコンソールログの両方をサポート
  - 最近のログの表示機能
- 名前付け規則（utils/naming.py）
  - ビュー名からdbtモデル名への変換
  - 命名規則プリセットの実装

### 3.2 BigQuery APIクライアントの実装（converter/bigquery.py）
- ✅ BigQueryクライアントクラスの作成
- ✅ データセットからビュー一覧を取得する機能
- ✅ ビュー定義を取得する機能
- ✅ Data Lineage APIを使用した依存関係取得機能

### 3.3 依存関係解析の実装（converter/dependency.py）
- ✅ 依存関係リゾルバークラスの作成
- ✅ 参照グラフの構築機能
- ✅ トポロジカルソートによる変換順序決定機能
- ✅ 循環参照の検出と処理

### 3.4 モデル生成の実装（converter/generator.py）
- ✅ モデルジェネレータークラスの作成
- ✅ SQLテンプレートとYAMLテンプレートの適用機能
- ✅ BigQueryテーブル参照をdbt ref()関数に変換する機能
- ✅ ファイル生成と保存機能

### 3.5 テンプレートの実装
- ✅ SQLモデルテンプレート（templates/model.sql）
- ✅ YAMLモデルテンプレート（templates/model.yml）

## 4. CLIインターフェースの実装

### 4.1 メインCLIエントリーポイント（cli.py）
- ✅ コマンドグループの定義
- ✅ グローバルオプションの設定
- ✅ サブコマンドの登録

### 4.2 インポートコマンドの実装（commands/import_cmd.py）
- ✅ コマンドライン引数の定義
- ⚠️ インタラクティブな確認機能 (部分的に実装)
- ✅ プログレス表示
- ✅ 変換プロセスの調整
- ✅ ビューフィルタリング機能

### 4.3 ログコマンドの実装（commands/logs_cmd.py）
- ⚠️ ログ表示コマンドの実装 (未実装または部分的に実装)
- ⚠️ 最近のログフィルタリング機能 (未実装または部分的に実装)

## 5. テストの実装

### 5.1 ユニットテストの作成
- ✅ BigQueryクライアントのテスト
- ✅ 依存関係リゾルバーのテスト
- ✅ モデルジェネレーターのテスト
- ✅ 名前付け規則のテスト

### 5.2 CLIテストの作成
- ✅ コマンドラインインターフェースのテスト
- ✅ インポートコマンドのテスト
- ⚠️ ログコマンドのテスト (未実装またはログコマンド自体が未実装)

### 5.3 結合テストの作成
- ⚠️ エンドツーエンドのワークフローテスト (部分的に実装)
- ✅ モック依存関係を使用したテスト

## 6. ドキュメントの作成

### 6.1 ユーザードキュメント
- ⚠️ インストール手順 (未実装または部分的に実装)
- ⚠️ 使用方法と例 (未実装または部分的に実装)
- ⚠️ コマンドリファレンス (未実装または部分的に実装)
- ⚠️ よくある質問と回答 (未実装または部分的に実装)

### 6.2 開発者ドキュメント
- ⚠️ アーキテクチャ概要 (未実装または部分的に実装)
- ⚠️ コンポーネント説明 (未実装または部分的に実装)
- ⚠️ 拡張方法 (未実装または部分的に実装)

## 7. リリース準備

### 7.1 コード品質確保
- ⚠️ lintツールの実行 (部分的に実装)
- ⚠️ 型チェックの実行 (部分的に実装)
- ⚠️ テストカバレッジの確認 (未実装)

### 7.2 パッケージングとリリース
- ⚠️ セマンティックバージョニングの適用 (未実装または部分的に実装)
- ⚠️ CHANGELOGの更新 (未実装)
- ⚠️ パッケージビルドとテスト (未実装)
- ⚠️ リリース手順の整備 (未実装)

## 改訂版実装プライオリティと段階 (2024/03/05 更新)

### フェーズ1 (基本機能) - ほぼ完了
1. ✅ プロジェクト構造の整備
2. ✅ 依存関係の設定
3. ✅ BigQueryクライアントの基本機能
4. ✅ 単純なモデル生成機能
5. ✅ 基本的なCLIインターフェース

### フェーズ2 (拡張機能) - 実装中
1. ✅ 依存関係解析機能
2. ✅ ref()参照変換機能
3. ⚠️ インタラクティブ確認機能 (部分的に実装)
4. ⚠️ ログ管理機能 (部分的に実装)

### フェーズ3 (完成度向上) - 今後の重点領域
1. ⚠️ エラーハンドリングの強化
2. ⚠️ ユーザーエクスペリエンスの改善
3. ⚠️ テストカバレッジの向上
4. ⚠️ ドキュメントの充実

### 追加フェーズ4 (品質向上とリリース準備) - 最終段階
1. テスト自動化と継続的インテグレーション
2. パッケージングとデプロイテスト
3. ユーザーフィードバックの収集体制
4. リリースプロセスの確立

## 今後の具体的なタスク (優先順位順)

1. **テスト品質の向上**
   - テストケースのエッジケースカバレッジ強化
   - テスト関数への型アノテーション追加
   - モック設計の最適化

2. **エラーハンドリングと安定性強化**
   - 例外処理の追加
   - ユーザーフレンドリーなエラーメッセージ
   - 回復可能なエラーからの復帰処理

3. **ログコマンドの実装完了**
   - ログ表示コマンドの追加
   - フィルタリングオプションの実装

4. **ドキュメントの充実**
   - ユーザーマニュアル作成
   - APIドキュメント生成
   - 使用例の追加

5. **リリース準備**
   - CI/CDパイプラインの設定
   - パッケージング検証
   - CHANGELOG作成 