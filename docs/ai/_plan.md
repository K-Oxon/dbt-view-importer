# bq2dbt プロジェクト実装計画

## 現在の進捗状況 (2024/03/13 更新)

### 完了したタスク
- プロジェクト構造の整備（フォルダ構造、基本ファイルの作成）
- 依存関係の設定（pyproject.toml）
- BigQuery APIクライアントの基本実装
  - ビュー一覧取得機能
  - ビュー定義取得機能
  - ビュースキーマ取得機能
  - テーブル依存関係取得機能（google-cloud-datacatalog-lineageを使用して実装）
- 依存関係解析機能の実装
  - ビュー間の依存関係解析（google-cloud-datacatalog-lineageを使用）
  - 指定されたdataset_idのビューのみ抽出するフィルタリング機能
  - 依存関係の視覚的表示機能（Richライブラリを使用）
- モデル生成機能の基本実装
  - jinjaテンプレートの実装（※human修正: white space制御）
- CLIインターフェースの基本実装
  - インポートコマンド
  - コマンドライン引数処理
- テストの実装と改善
  - BigQueryクライアントのテスト（MockRowクラスの修正含む）
  - LineageClientのテスト
  - 依存関係リゾルバーのテスト（analyze_dependenciesメソッドのテスト含む）
  - モデルジェネレーターのテスト
  - コマンドテスト
  - テストの統合と簡素化（重複テストの削除、テスト関数の統合）
- 型チェックの改善
  - py.typedファイルの追加
  - エラー処理の一貫性向上
- モジュール構造の改善
  - ビジネスロジックとCLIインターフェースの分離
  - BigQueryClientとLineageClientの分離
  - 単一責任の原則に基づいたモジュール設計
  - 依存関係の明確化と一方向の依存関係の確立

### 実装中/一部完了のタスク
- エラーハンドリングの強化（例外発生時に空リストを返すよう変更済み）
- インタラクティブモードの改善（ビュー名表示、一括確認、上書き確認など実装済み）

### 未着手/重点対応のタスク
- **ref()参照変換機能の実装** (ユーザーからの指示があるまで凍結 - 2024/03/13)
- ログコマンドの実装と修正（ログが保存・出力されない問題の解決）
- 最終変換結果のログ出力機能の追加（display_conversion_resultsの出力）
- naming-presetの微修正（名称変更とデフォルト変更）
- hatchを使ったバージョニングの追加
- ビルドとPyPIへのアップロード戦略の策定
- ドキュメントの作成と充実
- リリース準備（パッケージング、CHANGELOG作成）

## 1. プロジェクト構造の整備

### 1.1 ディレクトリ構造の作成
```
project_root/
├── .git/
├── .gitignore
├── README.md
├── pyproject.toml
├── tests/
│   ├── __init__.py
│   ├── conftest.py
│   ├── test_cli.py
│   └── test_converter.py
└── src/
    └── bq2dbt/
        ├── __init__.py
        ├── __main__.py
        ├── cli.py
        ├── commands/
        │   ├── __init__.py
        │   ├── import_views.py
        │   └── logs.py
        ├── converter/
        │   ├── __init__.py
        │   ├── bigquery.py
        │   ├── lineage.py
        │   ├── dependency.py
        │   ├── importer.py
        │   └── generator.py
        ├── templates/
        │   ├── __init__.py
        │   ├── model.sql
        │   └── model.yml
        └── utils/
            ├── __init__.py
            ├── logger.py
            └── naming.py
```

### 1.2 基本ファイルの作成
- READMEの作成（インストール手順、使い方を記載）
- .gitignoreの設定（Pythonプロジェクト用）
- pyproject.tomlの完成（依存関係の追加）

## 2. 依存関係の設定

### 2.1 必要なライブラリの追加
```toml
[project]
dependencies = [
    "click>=8.1.0,<9.0.0",
    "rich>=12.0.0,<13.0.0",
    "google-cloud-bigquery>=3.10.0,<4.0.0",
    "google-cloud-bigquery-datatransfer>=3.11.0,<4.0.0",
    "google-cloud-datacatalog-lineage>=0.2.0",  # 追加: 依存関係解析用
    "jinja2>=3.1.2,<4.0.0",
    "pyyaml>=6.0,<7.0",
]

[project.optional-dependencies]
dev = [
    "mypy>=1.15.0",
    "ruff>=0.9.9",
    "pytest>=7.0.0,<8.0.0",
    "pytest-cov>=4.0.0,<5.0.0",
    "pre-commit>=3.0.0,<4.0.0",
]
```

### 2.2 エントリーポイントの設定
```toml
[project.scripts]
bq2dbt = "bq2dbt.cli:main"
```

## 3. コア機能の実装

### 3.1 ユーティリティの実装
- ロガー（utils/logger.py）
  - ログレベル設定
  - ファイルログとコンソールログの両方をサポート
  - 最近のログの表示機能
- 名前付け規則（utils/naming.py）
  - ビュー名からdbtモデル名への変換
  - 命名規則プリセットの実装

### 3.2 BigQuery APIクライアントの実装（converter/bigquery.py）
- ✅ BigQueryクライアントクラスの作成
- ✅ データセットからビュー一覧を取得する機能
- ✅ ビュー定義を取得する機能
- ✅ テーブルスキーマを取得する機能
- ✅ テーブルタイプを取得する機能

### 3.3 Lineage APIクライアントの実装（converter/lineage.py）
- ✅ LineageClientクラスの作成
- ✅ Data Catalog Lineage APIを使用した依存関係取得機能

### 3.4 依存関係解析の実装（converter/dependency.py）
- ✅ 依存関係リゾルバークラスの作成
- ✅ 抽象基底クラス（DependencyResolverBase）の実装
- ✅ 具体的な実装（DataCatalogDependencyResolver）の実装
- ✅ 後方互換性のためのエイリアス（DependencyResolver）の維持
- ✅ 取得したビュー一覧と依存ビューの統合
- ✅ フィルタリングロジック（指定されたdataset_idのビューのみ抽出）
- ✅ 最大深さを指定した依存関係解析機能

### 3.5 モデル生成の実装（converter/generator.py）
- ✅ モデルジェネレータークラスの作成
- ✅ SQLテンプレートとYAMLテンプレートの適用機能
- ❄️ BigQueryテーブル参照をdbt ref()関数に変換する機能 (凍結中)
- ✅ ファイル生成と保存機能

### 3.6 インポート機能の実装（converter/importer.py）
- ✅ BigQueryクライアントの初期化
- ✅ モデルジェネレーターの初期化
- ✅ 出力ディレクトリの設定
- ✅ ビュー一覧の取得
- ✅ ビュー一覧の表示
- ✅ 依存関係の分析
- ✅ 追加されたビューの表示
- ✅ 順序付けられたビューの表示
- ✅ ファイルの存在確認
- ✅ ビューのインポート確認
- ✅ ビューの変換
- ✅ 変換結果の表示

### 3.7 テンプレートの実装
- ✅ SQLモデルテンプレート（templates/model.sql）
- ✅ YAMLモデルテンプレート（templates/model.yml）

## 4. CLIインターフェースの実装

### 4.1 メインCLIエントリーポイント（cli.py）
- ✅ コマンドグループの定義
- ✅ グローバルオプションの設定
- ✅ サブコマンドの登録

### 4.2 インポートコマンドの実装（commands/import_views.py）
- ✅ コマンドライン引数の定義
- ✅ インタラクティブな確認機能
- ✅ プログレス表示
- ✅ 変換プロセスの調整
- ✅ ビューフィルタリング機能
- ✅ 依存関係のあるビューのリッチな表示機能
- ⚠️ 最終変換結果のログ出力機能の追加 (未実装)

### 4.3 ログコマンドの実装（commands/logs.py）
- ⚠️ ログ表示コマンドの実装 (未実装)
- ⚠️ 最近のログフィルタリング機能 (未実装)
- ⚠️ ログが保存・出力されない問題の解決 (未実装)

## 5. テストの実装

### 5.1 ユニットテストの作成
- ✅ BigQueryクライアントのテスト
- ✅ LineageClientのテスト
- ✅ 依存関係リゾルバーのテスト
- ✅ モデルジェネレーターのテスト
- ✅ 名前付け規則のテスト
- ✅ インポート機能のテスト

### 5.2 CLIテストの作成
- ✅ コマンドラインインターフェースのテスト
- ✅ インポートコマンドのテスト
- ⚠️ ログコマンドのテスト (未実装)

### 5.3 結合テストの作成
- ⚠️ エンドツーエンドのワークフローテスト (部分的に実装)
- ✅ モック依存関係を使用したテスト

### 5.4 テストの改善
- ✅ テストの統合と簡素化（重複テストの削除、テスト関数の統合）
- ✅ モックの最適化
- ✅ テストの意図の明確化

## 6. ドキュメントの作成

### 6.1 ユーザードキュメント
- ⚠️ インストール手順 (未実装)
- ⚠️ 使用方法と例 (未実装)
- ⚠️ コマンドリファレンス (未実装)
- ⚠️ よくある質問と回答 (未実装)

### 6.2 開発者ドキュメント
- ⚠️ アーキテクチャ概要 (未実装)
- ⚠️ コンポーネント説明 (未実装)
- ⚠️ 拡張方法 (未実装)

## 7. リリース準備

### 7.1 コード品質確保
- ⚠️ lintツールの実行 (部分的に実装)
- ⚠️ 型チェックの実行 (部分的に実装)
- ⚠️ テストカバレッジの確認 (未実装)

### 7.2 パッケージングとリリース
- ⚠️ hatchを使ったバージョニングの追加 (未実装)
- ⚠️ ビルドとPyPIへのアップロード戦略の策定 (未実装)
- ⚠️ セマンティックバージョニングの適用 (未実装)
- ⚠️ CHANGELOGの更新 (未実装)
- ⚠️ パッケージビルドとテスト (未実装)
- ⚠️ リリース手順の整備 (未実装)

## 改訂版実装プライオリティと段階 (2024/03/13 更新)

### フェーズ1 (基本機能) - 完了
1. ✅ プロジェクト構造の整備
2. ✅ 依存関係の設定
3. ✅ BigQueryクライアントの基本機能
4. ✅ 単純なモデル生成機能 (テンプレート適用のみ)
5. ✅ 基本的なCLIインターフェース

### フェーズ2 (拡張機能) - 一部完了
1. ✅ 依存関係解析機能 (google-cloud-datacatalog-lineageを使用して実装完了)
2. ✅ インタラクティブ確認機能 (Richを使用したUI)
3. ❄️ ref()参照変換機能 (ユーザーからの指示があるまで凍結)
4. ⚠️ ログ管理機能 (部分的に実装)

### フェーズ3 (完成度向上) - 進行中
1. ✅ モジュール構造の改善
   - ✅ ビジネスロジックとCLIインターフェースの分離
   - ✅ BigQueryClientとLineageClientの分離
   - ✅ 単一責任の原則に基づいたモジュール設計
2. ✅ テストの改善
   - ✅ テストの統合と簡素化
   - ✅ モックの最適化
   - ✅ テストの意図の明確化
3. ⚠️ エラーハンドリングの強化 (部分的に実装)
4. ⚠️ ユーザーエクスペリエンスの改善 (部分的に実装)
5. ⚠️ ドキュメントの充実 (未実装)

### フェーズ4 (品質向上とリリース準備) - 未着手
1. テスト自動化と継続的インテグレーション
2. パッケージングとデプロイテスト
3. ユーザーフィードバックの収集体制
4. リリースプロセスの確立

## 今後の具体的なタスク (2024/03/13 更新・優先順位順)

1. **ログ機能の改善と修正**
   - ログが保存・出力されない問題の解決
   - ログ表示コマンドの実装
   - 最近のログフィルタリング機能
   - ログレベルの設定オプション
   - 最終変換結果のログ出力機能の追加（display_conversion_resultsの出力）

2. **naming-presetの微修正**
   - 名称の変更（humanからの具体案に基づく）
   - デフォルト値の変更（humanからの具体案に基づく）
   - 関連するテストの更新

3. **エラーハンドリングの強化**
   - 例外処理の追加
   - ユーザーフレンドリーなエラーメッセージ
   - 回復メカニズムの提供

4. **リリース準備とパッケージング**
   - hatchを使ったバージョニングの追加
   - ビルドとPyPIへのアップロード戦略の策定
   - セマンティックバージョニングの適用
   - CHANGELOGの更新
   - パッケージビルドとテスト
   - リリース手順の整備

5. **ドキュメントの作成**
   - インストール手順
   - 使用方法と例
   - コマンドリファレンス
   - アーキテクチャ概要
   - コンポーネント説明

6. **テストカバレッジの向上**
   - テストカバレッジの計測
   - カバレッジ目標の設定
   - 未カバーの部分のテスト追加

7. **❄️ ref()参照変換機能の実装** (凍結中 - ユーザーからの指示があるまで)
   - 参照パターン検出機能
   - dbt ref()関数への変換ロジック
   - エッジケース対応

## 新規タスク詳細 (2024/03/13 追加)

### 1. 最終変換結果のログ出力機能

#### 問題点
- 現在、変換処理の最終結果（display_conversion_results）がログに出力されていない
- 変換処理の結果を後から確認する手段がない

#### 実装計画
- `converter/importer.py`の`display_conversion_results`関数を修正し、ログ出力を追加
- 変換されたモデル数、スキップされたモデル数、エラーが発生したモデル数などの統計情報をログに記録
- 変換されたファイルのパスリストをログに記録
- ログレベルはINFOとし、常に記録されるようにする

### 2. naming-presetの微修正

#### 問題点
- 現在のnaming-presetの名称が直感的でない
- デフォルト値が最適でない

#### 実装計画
- humanからの具体的な指示に基づいて名称を変更
- デフォルト値を変更
- 関連するテストを更新
- ドキュメントを更新して新しい名称とデフォルト値を反映

### 3. ログコマンドの問題解決

#### 問題点
- ログが正しく保存されない、または出力されない
- ログコマンドの挙動が期待通りでない

#### 実装計画
- ロギング設定の見直し
  - ログファイルのパス設定の確認
  - ログレベルの設定確認
  - ログフォーマットの確認
- ログハンドラーの実装確認
  - ファイルハンドラーが正しく設定されているか
  - コンソールハンドラーが正しく設定されているか
- ログコマンドの実装
  - 最近のログを表示する機能
  - ログレベルでフィルタリングする機能
  - 日付範囲でフィルタリングする機能

### 4. hatchを使ったバージョニング

#### 問題点
- 現在、バージョン管理の仕組みが整備されていない
- リリースプロセスが確立されていない

#### 実装計画
- hatchのインストールと設定
  - pyproject.tomlにhatch設定を追加
  - バージョン管理スキームの設定（セマンティックバージョニング）
- バージョン更新コマンドの整備
  - メジャー、マイナー、パッチバージョンの更新方法
  - プレリリースとビルドメタデータの扱い
- CIパイプラインとの統合
  - タグ付けとリリース作成の自動化
  - バージョン番号の自動インクリメント

### 5. ビルドとPyPIへのアップロード戦略

#### 問題点
- パッケージのビルドプロセスが確立されていない
- PyPIへのアップロード手順が整備されていない

#### 実装計画
- ビルド設定の整備
  - pyproject.tomlのビルド設定
  - パッケージメタデータの設定
  - 含めるファイルと除外するファイルの設定
- ビルドプロセスの自動化
  - ビルドスクリプトの作成
  - CIでのビルド自動化
- PyPIアップロードの自動化
  - テストPyPI環境の活用
  - 本番PyPIへのアップロード手順
  - APIトークンの安全な管理
- リリースチェックリストの作成
  - リリース前の確認事項
  - リリース後の確認事項 