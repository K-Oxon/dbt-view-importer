# bq2dbt プロジェクト実装メモ

## プロジェクト概要
- BigQueryのビューをdbtモデルに自動変換するCLIツール
- 主要機能：ビュー検出、依存関係分析、モデル生成、参照変換、インタラクティブ確認
- 技術スタック：Python 3.9+、BigQuery API、Rich UI、Jinja2テンプレート

## 現状分析 (2024/03/11 更新)
- 基本的なプロジェクト構造が整備された
- jinjaテンプレートのwhite space制御についてhumanが修正を行った (commit: fbe87252)
- コア機能の一部が実装完了
  - BigQueryクライアント（ビュー一覧取得、定義取得、スキーマ取得）
  - モデル生成の基本部分（テンプレート適用）
  - **依存関係解析機能** (`google-cloud-datacatalog-lineage`を使用して実装完了)
  - エラー処理の一貫性を改善（エラー時に空リストを返すように変更）
- 重要なコア機能でまだ未実装のもの
  - **インタラクティブモード** (未実装)
  - **ref()参照変換機能** (依存関係解析後に実装予定)
- CLIインターフェースの基本実装完了
  - インポートコマンドの引数処理
  - プログレス表示
  - ビューフィルタリング
- テストの品質向上の取り組み
  - BigQueryClientのモックテストを実際の実装と整合させるよう修正
  - MockRowクラスに__getitem__メソッドを追加して辞書アクセスをサポート
  - 依存関係解析機能のテスト実装
  - py.typedファイルの追加による型チェックの改善

## 必要な機能コンポーネント
1. BigQuery クライアント ✅
   - ✅ データセットからビュー一覧取得
   - ✅ ビュー定義の取得
   - ✅ テーブルスキーマの取得
   - ✅ Lineage API接続（google-cloud-datacatalog-lineageを使用）

2. 依存関係リゾルバー ✅
   - ✅ ビュー間の依存関係解析（`google-cloud-datacatalog-lineage`を使用）
   - ✅ 指定されたdataset_idのビューのみ抽出するフィルタリング
   - ✅ 取得したビュー一覧と依存ビューの統合
   - ✅ Richを使用した依存関係の視覚的表示

3. モデルジェネレーター ⚠️
   - ✅ ビュー定義からdbtモデル生成 (テンプレート適用のみ)
   - ⚠️ 参照をref()関数に変換 (依存関係解析機能が完了したので次に実装予定)
   - ✅ テンプレート適用

4. CLIインターフェース ⚠️
   - ✅ コマンドライン引数処理
   - ⚠️ インタラクティブプロンプト (未実装)
   - ✅ 進捗表示
   - ⚠️ ログ表示コマンド (未実装)

5. ユーティリティ ⚠️
   - ⚠️ ロギング (部分的に実装)
   - ✅ 名前付け規則
   - ✅ エラーハンドリング (一貫性のある例外処理を実装)

## 今後のフォーカスエリア

### 短期目標 (2024/03/11更新・1-2週間)
1. ✅ 依存関係解析機能の実装
   - ✅ `google-cloud-datacatalog-lineage`ライブラリの追加
   - ✅ BigQuery Data Catalog Lineage APIを使用した依存関係取得
   - ✅ 指定されたdataset_idのビューのみ抽出するフィルタリング
   - ✅ 取得したビュー一覧と依存ビューの統合
   - ✅ Richを使用した依存関係の視覚的表示

2. インタラクティブモードの実装
   - Rich TUIを使用したインタラクティブプロンプト
   - 依存関係のあるビューの確認UI
   - ファイル上書き確認の実装
   - 進捗表示の強化

3. ref()参照変換機能の実装
   - 参照パターン検出機能
   - dbt ref()関数への変換ロジック
   - エッジケース対応

4. ✅ テスト品質の向上
   - ✅ 依存関係解析機能のテスト実装
   - ✅ モック設計の最適化
   - ✅ 型チェックの改善（py.typedファイルの追加）

### 中期目標 (2-4週間)
1. エラーハンドリングの強化
   - 例外処理の追加
   - ユーザーフレンドリーなエラーメッセージ

2. ログコマンドの実装
   - ログ表示機能
   - フィルタリングオプション

3. ドキュメントの作成
   - インストール手順
   - 使用方法と例
   - コマンドリファレンス

### 長期目標 (1-2ヶ月)
1. リリース準備
   - パッケージングとリリースフロー
   - CHANGELOG管理

2. ユーザーフィードバック収集
   - テスターからのフィードバック収集体制
   - 課題追跡システムの設定

3. 拡張機能の検討
   - インクリメンタルモデル対応
   - 高度なテンプレートオプション

## テスト実装状況

現在のテスト実装状況:
- BigQueryClient テスト: 依存関係取得を含めた全機能のテスト完了
- 依存関係解析テスト: analyze_dependencies メソッドを含む完全なテスト実装
- モデル生成テスト: 基本機能のテスト完了、ref()変換機能のテストは後回し
- コマンドテスト: 基本コマンドのテスト完了

最近対応した課題:
- BigQueryClientのモックに__getitem__メソッドを追加し、辞書アクセスに対応
- get_table_dependencies メソッドのエラー処理を改善（エラー時に空リストを返す）
- 依存関係解析機能のテストを実装
- 型チェック改善のためにpy.typedファイルを追加

今後のテスト改善点:
- インタラクティブモードのテスト実装
- ref()参照変換機能のテスト実装
- コードカバレッジの計測と向上
- より複雑なユースケースのテスト追加

## 開発メモ

### 人間からのフィードバック (2024/03/11)
- 依存関係解析機能の実装が完了
- テストの改善方針（MockRowクラスの修正、エラー処理の一貫性）に同意
- 型チェック改善のため、py.typedファイルの追加方式を採用

### 実装した依存関係解析機能の概要
- BigQueryClientの`get_table_dependencies`メソッドをGoogle Cloud Datacatalog Lineage APIを使用して実装
- DependencyResolverクラスに`analyze_dependencies`メソッドを追加
- 指定されたデータセット内のビューのみをフィルタリングする機能
- 依存関係の視覚的表示機能（Richライブラリを使用）
- エラー処理の強化（例外発生時に空リストを返すよう変更）

### ref()参照変換機能の実装計画
- 依存関係解析機能が完了したので、次はref()参照変換機能を実装
- 参照パターン検出方法の検討
- 依存関係情報を活用した変換ルールの設計
- エッジケース対応の考慮

### インタラクティブモード実装アプローチ
- Rich TUIライブラリを活用したインタラクティブプロンプト
- 依存関係のあるビューを表示するリスト選択UI
- ファイル上書きを確認するプロンプト
- --non-interactiveフラグによるバッチモード切り替え
- ユーザーエクスペリエンスを考慮したプロンプトデザイン 