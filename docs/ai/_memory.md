# bq2dbt プロジェクト実装メモ

## プロジェクト概要
- BigQueryのビューをdbtモデルに自動変換するCLIツール
- 主要機能：ビュー検出、依存関係分析、モデル生成、参照変換、インタラクティブ確認
- 技術スタック：Python 3.9+、BigQuery API、Rich UI、Jinja2テンプレート

## 現状分析 (2024/03/05 更新)
- 基本的なプロジェクト構造が整備された
- コア機能の大部分が実装完了
  - BigQueryクライアント（ビュー一覧取得、定義取得、スキーマ取得、依存関係取得）
  - 依存関係解析（参照グラフ構築、トポロジカルソート）
  - モデル生成（SQLモデル、YAMLモデル、ref()変換）
- CLIインターフェースの基本実装完了
  - インポートコマンドの引数処理
  - プログレス表示
  - ビューフィルタリング
- テストの基本実装完了
  - 各コンポーネントの単体テスト
  - コマンドテスト
- テストの品質向上に取り組み中
  - モックの適切な実装
  - エッジケースのカバレッジ

## 必要な機能コンポーネント
1. BigQuery クライアント ✅
   - ✅ データセットからビュー一覧取得
   - ✅ ビュー定義の取得
   - ✅ Lineage API接続

2. 依存関係リゾルバー ✅
   - ✅ ビュー間の依存関係解析
   - ✅ 参照グラフ構築
   - ✅ 変換順序の決定（トポロジカルソート）

3. モデルジェネレーター ✅
   - ✅ ビュー定義からdbtモデル生成
   - ✅ 参照をref()関数に変換
   - ✅ テンプレート適用

4. CLIインターフェース ⚠️
   - ✅ コマンドライン引数処理
   - ⚠️ インタラクティブプロンプト (部分的に実装)
   - ✅ 進捗表示
   - ⚠️ ログ表示コマンド (未実装)

5. ユーティリティ ⚠️
   - ⚠️ ロギング (部分的に実装)
   - ✅ 名前付け規則
   - ⚠️ エラーハンドリング (改善が必要)

## 今後のフォーカスエリア

### 短期目標 (1-2週間)
1. テスト品質の向上
   - 型アノテーションの追加
   - モック設計の最適化
   - エッジケースのカバレッジ拡大

2. エラーハンドリングの強化
   - 例外処理の追加
   - ユーザーフレンドリーなエラーメッセージ

3. ログコマンドの実装
   - ログ表示機能
   - フィルタリングオプション

### 中期目標 (2-4週間)
1. ドキュメントの作成
   - インストール手順
   - 使用方法と例
   - コマンドリファレンス

2. インタラクティブ機能の強化
   - 依存関係のあるビューの確認UI
   - ファイル上書き確認の改善

3. テスト自動化
   - CI/CDパイプラインの設定
   - テストカバレッジレポート

### 長期目標 (1-2ヶ月)
1. リリース準備
   - パッケージングとリリースフロー
   - CHANGELOG管理

2. ユーザーフィードバック収集
   - テスターからのフィードバック収集体制
   - 課題追跡システムの設定

3. 拡張機能の検討
   - インクリメンタルモデル対応
   - 高度なテンプレートオプション

## テスト実装状況

現在のテスト実装状況:
- BigQueryClient テスト: 基本機能のテスト完了
- 依存関係解析テスト: 基本機能のテスト完了
- モデル生成テスト: 基本機能のテスト完了
- コマンドテスト: 基本コマンドのテスト完了

最近対応した課題:
- BigQueryClientのモックテストが実際の実装と整合していなかった問題の修正
- 特に`list_views`メソッドと`get_view_definition`メソッドのテストを修正
- コマンドテストのアサーションを実際の実装に合わせて更新

今後のテスト改善点:
- エラーケースのテスト追加
- コードカバレッジの計測と向上
- より複雑なユースケースのテスト追加
- テスト関数に型アノテーションを追加してlinterエラーを解消

## 開発メモ

### BigQuery APIクライアント
- BigQueryクライアントは現在、Information Schemaからビュー定義を取得
- Data Lineage APIの完全実装は今後必要

### 依存関係解析
- 循環参照検出が正しく機能している
- エラーハンドリングの強化が必要

### モデル生成
- テンプレート適用の柔軟性をさらに高めたい
- 命名規則プリセットの拡張を検討

### CLIインターフェース
- ログコマンドの実装が未完了
- インタラクティブモードのUXを改善したい 