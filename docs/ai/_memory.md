# bq2dbt プロジェクト実装メモ

## プロジェクト概要
- BigQueryのビューをdbtモデルに自動変換するCLIツール
- 主要機能：ビュー検出、依存関係分析、モデル生成、参照変換、インタラクティブ確認
- 技術スタック：Python 3.9+、BigQuery API、Rich UI、Jinja2テンプレート

## 現状分析 (2024/03/08 更新)
- 基本的なプロジェクト構造が整備された
- jinjaテンプレートのwhite space制御についてhumanが修正を行った (commit: fbe87252)
- コア機能の一部が実装完了
  - BigQueryクライアント（ビュー一覧取得、定義取得、スキーマ取得）
  - モデル生成の基本部分（テンプレート適用）
- 重要なコア機能が未実装
  - **依存関係解析機能** (`google-cloud-datacatalog-lineage`を使用、未実装)
  - **インタラクティブモード** (未実装)
  - **ref()参照変換機能** (依存関係解析後に実装予定)
- CLIインターフェースの基本実装完了
  - インポートコマンドの引数処理
  - プログレス表示
  - ビューフィルタリング
- テストの基本実装完了
  - 各コンポーネントの単体テスト
  - コマンドテスト
- テストの品質向上に取り組み中
  - モックの適切な実装
  - エッジケースのカバレッジ

## 必要な機能コンポーネント
1. BigQuery クライアント ✅
   - ✅ データセットからビュー一覧取得
   - ✅ ビュー定義の取得
   - ✅ テーブルスキーマの取得
   - ⚠️ Lineage API接続 (google-cloud-datacatalog-lineageを使用する方針に変更)

2. 依存関係リゾルバー ⚠️
   - ⚠️ ビュー間の依存関係解析 (`google-cloud-datacatalog-lineage`を使用)
   - ⚠️ 指定されたdataset_idのビューのみ抽出するフィルタリング
   - ⚠️ 取得したビュー一覧と依存ビューの統合
   - ⚠️ Richを使用した依存関係の視覚的表示

3. モデルジェネレーター ⚠️
   - ✅ ビュー定義からdbtモデル生成 (テンプレート適用のみ)
   - ⚠️ 参照をref()関数に変換 (依存関係解析後に実装)
   - ✅ テンプレート適用

4. CLIインターフェース ⚠️
   - ✅ コマンドライン引数処理
   - ⚠️ インタラクティブプロンプト (未実装)
   - ✅ 進捗表示
   - ⚠️ ログ表示コマンド (未実装)

5. ユーティリティ ⚠️
   - ⚠️ ロギング (部分的に実装)
   - ✅ 名前付け規則
   - ⚠️ エラーハンドリング (改善が必要)

## 今後のフォーカスエリア

### 短期目標 (2024/03/08更新・1-2週間)
1. 依存関係解析機能の実装
   - `google-cloud-datacatalog-lineage`ライブラリの追加
   - BigQuery Data Catalog Lineage APIを使用した依存関係取得
   - 指定されたdataset_idのビューのみ抽出するフィルタリング
   - 取得したビュー一覧と依存ビューの統合
   - Richを使用した依存関係の視覚的表示
   
2. インタラクティブモードの実装
   - Rich TUIを使用したインタラクティブプロンプト
   - 依存関係のあるビューの確認UI
   - ファイル上書き確認の実装
   - 進捗表示の強化

3. テスト品質の向上
   - 依存関係解析機能のテスト実装
   - モック設計の最適化
   - 型アノテーションの追加

### 中期目標 (2-4週間)
1. ref()参照変換機能の実装 (依存関係解析後)
   - 参照パターン検出機能
   - dbt ref()関数への変換ロジック
   - エッジケース対応

2. エラーハンドリングの強化
   - 例外処理の追加
   - ユーザーフレンドリーなエラーメッセージ

3. ログコマンドの実装
   - ログ表示機能
   - フィルタリングオプション

4. ドキュメントの作成
   - インストール手順
   - 使用方法と例
   - コマンドリファレンス

### 長期目標 (1-2ヶ月)
1. リリース準備
   - パッケージングとリリースフロー
   - CHANGELOG管理

2. ユーザーフィードバック収集
   - テスターからのフィードバック収集体制
   - 課題追跡システムの設定

3. 拡張機能の検討
   - インクリメンタルモデル対応
   - 高度なテンプレートオプション

## テスト実装状況

現在のテスト実装状況:
- BigQueryClient テスト: 基本機能のテスト完了
- 依存関係解析テスト: 基本構造のみ、依存関係解析機能の実装に伴い拡充必要
- モデル生成テスト: 基本機能のテスト完了、ref()変換機能のテストは後回し
- コマンドテスト: 基本コマンドのテスト完了

最近対応した課題:
- BigQueryClientのモックテストが実際の実装と整合していなかった問題の修正
- 特に`list_views`メソッドと`get_view_definition`メソッドのテストを修正
- コマンドテストのアサーションを実際の実装に合わせて更新

今後のテスト改善点:
- 依存関係解析機能のテスト実装（`google-cloud-datacatalog-lineage`のモック）
- インタラクティブモードのテスト実装
- エラーケースのテスト追加
- コードカバレッジの計測と向上
- より複雑なユースケースのテスト追加
- テスト関数に型アノテーションを追加してlinterエラーを解消

## 開発メモ

### 人間からのフィードバック (2024/03/08)
- jinjaのwhite spaceを制御する修正がhumanにより行われた (commit: fbe87252)
- 依存関係解析機能は`google-cloud-datacatalog-lineage`ライブラリを使用する
- 厳密なグラフ構造管理は不要で、必要なのは:
  - 指定されたdataset_idのビューのみ抽出するフィルタリング
  - 取得したビュー一覧に依存関係で必要になったビューを追加
  - 結果をRichの画面に出力
- ref()参照変換機能は依存関係解析後に実装する
- インタラクティブモードの実装方針はOK

### 依存関係解析機能の実装アプローチ
- `google-cloud-datacatalog-lineage`ライブラリを使用
- BigQuery Data Catalog Lineage APIを使用した依存関係取得
- 厳密なグラフ構造の管理は行わず、必要なビューのリストを作成
- 指定されたdataset_idのフィルタリングを実装
- 取得したビュー一覧と依存ビューの統合処理
- Richを使用した依存関係の視覚的表示

### ref()参照変換機能のアプローチ (依存関係解析後)
- 依存関係解析が完了してから設計・実装を行う
- 参照パターン検出は依存関係情報を活用
- 変換ルールは依存関係の情報に基づいて定義

### インタラクティブモード実装アプローチ
- Rich TUIライブラリを活用したインタラクティブプロンプト
- 依存関係のあるビューを表示するリスト選択UI
- ファイル上書きを確認するプロンプト
- --non-interactiveフラグによるバッチモード切り替え
- ユーザーエクスペリエンスを考慮したプロンプトデザイン 