# 20250311_humanからの指示

この文章は人間からの連絡文書です。内容を読み込んで`docs/ai/_memory.md`と`docs/ai/_plan.md`を更新すること。

## リファクタリングについて

ここまでの実装ですでにイマイチな点が出始めているので現在の計画に差し込みでリファクタリングを実施します。
下記内容を良く読んでリファクタリング方針を策定し、`docs/ai/_refactoring.md`に出力しなさい。

リファクタリング考慮項目

- 一つひとつのクラスや関数が肥大化しているので単一責務の原則に従って単一責務のみを担っているか改めて見返して細かく分解すること
- datacatalog lineage clientがbigquery clientと同居しているのも責務を担いすぎです。単一責務にこだわってください
- ifやforのネストは禁止します  早期returnを忠実に行い、もしネストが必要ならその責務を担う関数やクラスに切り分けること
- `import_cmd.py`の見通しが非常に悪いので上記に従って可読性を向上させること
- 将来的な拡張を見越して現在のdir構成が適切なのか見直したい  責務の所在が明確になっているか？
- src/bq2dbt/commands/配下の foo_cmd.py というネーミングは_cmdの部分が自明なのでシンプルでクリアなネーミングにすること（他のモジュールも同様）
- `src/bq2dbt/converter/dependencies.py`のDependencyResolverクラスの挙動と機能に不満があります。datacatalog lineage clientで依存関係を取得した後の、グラフ構築や循環参照が無いか調べる処理がとても遅いしやりたいことに対して過剰です。単純に、再帰的にdatacatalog lineage clientで深さを決めてソースを取得するシンプルな方法に変えること。 (深さを決めているので循環参照かどうかは問題ではなくなるはず。)
- 依存関係の解析は後々datacatalog lineage client以外(SQL自体の解析など)でも実装できるように抽象化しておくこと。
