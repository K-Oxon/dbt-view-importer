# dbt-view-importer

BigQueryビューをdbtモデルに自動変換するツール。

## 概要

このツールは、指定したBigQueryデータセット内のビューを検出し、適切なdbtモデル（SQLファイルとYAMLファイル）に変換します。また、ビュー間の依存関係も解析し、変換順序を最適化します。主な機能は以下の通りです：

- BigQueryデータセットからビューを自動検出
- ビュー間の依存関係を解析（Data Catalog Lineage APIを使用）
- 依存関係に基づいた最適な変換順序の決定
- dbtモデル（SQLとYAML）の自動生成
- カスタマイズ可能なテンプレートによるモデル生成

## 注意点

- Lineageの取得ができない場合があり、少し時間を置くと解決するかもしれません

## インストール

### 前提条件

- Python 3.9以上
- Google Cloud認証済み環境（BigQueryとData Catalog Lineage APIへのアクセス権限が必要）

### インストール手順

```bash
pip install git+https://github.com/K-Oxon/dbt-view-importer.git
```

## 使用方法

### コマンドの基本構造

```bash
bq2dbt [コマンド] [オプション]
```

### 主要コマンド

#### ビューのインポート

##### 基本的な使用方法（必須オプションのみ）

```bash
bq2dbt import views \
  --project-id <PROJECT_ID> \
  --dataset <DATASET_ID> \
  --output-dir <OUTPUT_DIR>
```

##### 全オプションを使用した例

```bash
bq2dbt import views \
  --project-id <PROJECT_ID> \
  --dataset <DATASET_ID> \
  --output-dir <OUTPUT_DIR> \
  --naming-preset full \
  --include-views "report_*,mart_*" \
  --exclude-views "temp_*,test_*" \
  --include-dependencies \
  --max-depth 3 \
  --sql-template <template_file> \
  --yml-template <template_file> \
  --yml-prefix <prefix_string> \
  --location asia-northeast1 \
  --non-interactive \
  --dry-run \
  --debug
```

##### オプションの詳細

###### 必須オプション

- `--project-id <PROJECT_ID>`
  - BigQueryプロジェクトID
  - 例: `--project-id my-gcp-project`

- `--dataset <DATASET_ID>`
  - インポート対象のBigQueryデータセット
  - 例: `--dataset my_dataset`

- `--output-dir <OUTPUT_DIR>`
  - dbtモデルの出力先ディレクトリ
  - 例: `--output-dir models/staging`

###### 命名規則オプション

- `--naming-preset <PRESET>`
  - モデル命名規則のプリセット
  - 選択肢: `full`（デフォルト）, `table_only`, `dataset_without_prefix`
  - `table_only`: テーブル名のみを使用（例: `sales.revenue` → `revenue.sql`）
  - `full`: データセット名とテーブル名を使用（例: `sales.revenue` → `sales__revenue.sql`）
  - `dataset_without_prefix`: データセットからプレフィックスを除去しテーブル名と`__`で結合（例: `dm_sales.revenue` → `sales__revenue.sql`）

###### フィルタリングオプション

- `--include-views <PATTERNS>`
  - インポート対象のビュー名パターン（カンマ区切り）
  - 例: `--include-views "*.sample_dataset.*,mart_*"`

- `--exclude-views <PATTERNS>`
  - インポート対象から除外するビュー名パターン（カンマ区切り）
  - 例: `--exclude-views "*.temp_dataset.*,test_*"`

- `--non-interactive`
  - インタラクティブな確認をスキップするフラグ
  - 指定すると、ユーザーに確認せずに全てのビューを変換

###### 依存関係オプション

- `--include-dependencies`
  - 依存関係にあるビューも含めてインポートするフラグ
  - 指定すると、選択したビューが依存する他のビューも自動的にインポート

- `--max-depth <DEPTH>`
  - 依存関係の最大深度（`--include-dependencies`使用時）
  - デフォルト: 3
  - 例: `--max-depth 5`（より深い依存関係まで取得）

###### テンプレートオプション

- `--sql-template <TEMPLATE_FILE>`
  - SQLモデル用のJinja2テンプレートファイル
  - 指定しない場合はデフォルトテンプレートを使用
  - 例: `--sql-template templates/custom_model.sql`

- `--yml-template <TEMPLATE_FILE>`
  - YAMLモデル用のJinja2テンプレートファイル
  - 指定しない場合はデフォルトテンプレートを使用
  - 例: `--yml-template templates/custom_model.yml`

- `--yml-prefix <PREFIX_STRING>`
  - ymlファイルの接頭辞を指定する
  - 例: `--yml-prefix _` -> `_model_name.yml`が生成される

###### 実行オプション

- `--dry-run`
  - 実際にファイルを作成せずに実行するフラグ
  - 指定すると、変換対象のビューと出力先を表示するのみ

- `--location <LOCATION>`
  - BigQueryのロケーション
  - デフォルト: `asia-northeast1`
  - 例: `--location us-central1`

- `--debug`
  - デバッグモードを有効化するフラグ
  - 指定すると、より詳細なログ情報を表示

#### ログの表示

```bash
# 最近のログ一覧を表示
bq2dbt logs list

# 最新のログを表示
bq2dbt logs show --last
```

### インタラクティブモード

デフォルトでは、ツールはインタラクティブモードで実行され、以下の確認を行います：

1. 検出されたビューの一覧表示
2. 依存関係の分析と表示
3. 各ビューのインポート確認
4. 既存ファイルの上書き確認

非インタラクティブモードを使用する場合は、`--non-interactive`オプションを指定します：

```bash
bq2dbt import views \
  --project-id <PROJECT_ID> \
  --dataset <DATASET_ID> \
  --output-dir <OUTPUT_DIR> \
  --non-interactive
```

### テンプレートのカスタマイズ

dbt-view-importerは、SQLモデルとYAMLモデルの生成に使用するテンプレートをカスタマイズすることができます。これにより、組織固有の命名規則やdbt設定を適用できます。

#### デフォルトテンプレート

##### SQLモデルテンプレート（model.sql）

```sql
-- dbt model configuration
{{ "{{" }}
    config(
        materialized='view'
    )
{{ "}}" }}

-- Original BigQuery view: {{ source_view }}
-- Generated by bq2dbt at {{ timestamp }}

{{ sql_definition }}
```

##### YAMLモデルテンプレート（model.yml）

```yaml
version: 2

models:
  - name: {{ model_name }}
    description: |
      {{ description | default('') }}
    columns:
{%- for column in columns %}
      - name: {{ column.name }}
        description: |
          {{ column.description | default('') }}
{%- endfor %}
```

#### カスタムテンプレートの作成

独自のテンプレートを作成する場合は、以下の変数を使用できます：

##### SQLテンプレートで使用可能な変数

- `{{ source_view }}`: 元のBigQueryビューの完全修飾名（例: `project.dataset.view_name`）
- `{{ timestamp }}`: 生成時のタイムスタンプ
- `{{ sql_definition }}`: BigQueryビューのSQL定義

##### YAMLテンプレートで使用可能な変数

- `{{ model_name }}`: dbtモデル名
- `{{ description }}`: ビューの説明
- `{{ columns }}`: カラム情報のリスト（各カラムは `name` と `description` 属性を持つ）

#### カスタムテンプレートの例

##### カスタムSQLテンプレート例

```sql
-- dbt model configuration
{{ "{{" }}
    config(
        enabled=true,
        dataset="{{ source_view.split('.')[1] }}",
        alias="{{ source_view.split('.')[2] }}",
        materialized="view"
    )
{{ "}}" }}

-- Original BigQuery view: {{ source_view }}
-- Generated by bq2dbt at {{ timestamp }}
-- This model is part of the data warehouse

{{ sql_definition }}
```

##### カスタムYAMLテンプレート例

```yaml
version: 2

models:
  - name: {{ model_name }}
    description: "{{ description | default('') }}"
    config:
      persist_docs:
        relation: true
        columns: true
      meta:
        source: "BigQuery"
        source_view: "{{ source_view }}"
    columns:
{%- for column in columns %}
      - name: {{ column.name }}
        description: "{{ column.description | default('') }}"
{%- endfor %}
```

#### テンプレートの使用方法

カスタムテンプレートを使用するには、`--sql-template` と `--yml-template` オプションでテンプレートファイルのパスを指定します：

```bash
bq2dbt import views \
  --project-id <PROJECT_ID> \
  --dataset <DATASET_ID> \
  --output-dir <OUTPUT_DIR> \
  --sql-template path/to/custom_model.sql \
  --yml-template path/to/custom_model.yml
```

### デバッグモード

より詳細な情報を表示するデバッグモードを使用することができます：

```bash
bq2dbt import views \
  --project-id <PROJECT_ID> \
  --dataset <DATASET_ID> \
  --output-dir <OUTPUT_DIR> \
  --debug
```

## 開発者向け情報

### cloneとインストール

```bash
# リポジトリをクローン
git clone https://github.com/K-Oxon/dbt-view-importer.git
cd dbt-view-importer

# uvを使って開発モードでインストール
uv sync
```

### テストの実行

```bash
# すべてのテストを実行
./scripts/run_tests.sh

# BigQuery連携テストも実行（環境変数の設定が必要）
export BQ_PROJECT_ID=your-project
export BQ_DATASET_ID=your_dataset
./scripts/run_tests.sh --with-bq

# 特定のテストを実行
./scripts/run_tests.sh "" tests/converter/test_generator.py
```

### デバッグ用インポート

```bash
# 環境変数の設定
export BQ_PROJECT_ID=your-project
export BQ_DATASET_ID=your_dataset

# デバッグモードでインポート実行
./scripts/debug_import.sh output_dir
```

## プロジェクト構造

```
src/bq2dbt/
├── cli.py                # CLIエントリーポイント
├── commands/             # コマンド定義
│   ├── importer.py       # インポートコマンドグループ
│   ├── import_views.py   # ビューインポートコマンド
│   └── logs.py           # ログコマンド
├── converter/            # 変換ロジック
│   ├── bigquery.py       # BigQueryクライアント
│   ├── dependency.py     # 依存関係解析
│   ├── generator.py      # モデル生成
│   ├── importer.py       # インポートビジネスロジック
│   └── lineage.py        # Lineage API連携
├── templates/            # テンプレート
│   ├── model.sql         # SQLモデルテンプレート
│   └── model.yml         # YAMLモデルテンプレート
└── utils/                # ユーティリティ
    ├── logging.py        # ロギング
    └── naming.py         # 命名規則
```

## アーキテクチャ

このツールは以下のコンポーネントで構成されています：

### コマンドレイヤー
- `commands/importer.py`: インポートコマンドグループを定義
- `commands/import_views.py`: ビューインポートコマンドを定義
- `commands/logs.py`: ログ表示コマンドを定義

### ビジネスロジックレイヤー
- `converter/importer.py`: インポート処理のビジネスロジックを実装
- `converter/bigquery.py`: BigQueryとの連携機能を提供
- `converter/lineage.py`: Data Catalog Lineage APIとの連携機能を提供
- `converter/dependency.py`: 依存関係解析機能を提供
- `converter/generator.py`: dbtモデル生成機能を提供

### ユーティリティレイヤー
- `utils/naming.py`: 命名規則関連のユーティリティを提供
- `utils/logging.py`: ロギング機能を提供

この階層化されたアーキテクチャにより、ビジネスロジックとユーザーインターフェースが明確に分離され、コードの保守性と拡張性が向上しています。

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。
